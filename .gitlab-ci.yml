
stages:          # List of stages for jobs, and their order of execution
  - build
  - scheduled_for_build_image
  # - deploy

variables:
  DOCKER_REGISTRY: 555726879390.dkr.ecr.us-east-1.amazonaws.com
  AWS_DEFAULT_REGION: us-east-1
  APP_NAME: clarusway-repo/petclinic-app-dev
  DOCKER_HOST: tcp://docker:2375

build_react_image:
  image: 
    name: amazon/aws-cli
    entrypoint: [""]

  stage: scheduled_for_build_image
  services:
    - docker:dind
  before_script:
    - amazon-linux-extras install docker
    - aws --version
    - docker --version
    - pwd && ls -ltar && df -h
  script:
    - docker build -t $DOCKER_REGISTRY/$APP_NAME:$CI_PIPELINE_IID . 
    - aws ecr get-login-password | docker login --username AWS --password-stdin $DOCKER_REGISTRY
    - docker push $DOCKER_REGISTRY/$APP_NAME:$CI_PIPELINE_IID
  rules:
    - if: ($CI_COMMIT_BRANCH == "test") && ($CI_PIPELINE_SOURCE == "schedule")
      changes:
      - src/*


# build_terraform_env:
#   stage: build
#   services:
#     - docker:dind
#   before_script:
#     - amazon-linux-extras install docker
#     - yum install -y yum-utils
#     - yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
#     - yum -y install terraform
#     - aws --version
#     - docker --version
#     - terraform --version
#     - pwd && ls -ltar && df -h
#   script:
#     - aws ecr get-login-password | docker login --username AWS --password-stdin $DOCKER_REGISTRY
#     - aws s3 ls
#   allow_failure: false
  
#   rules:
#    - if: ($CI_COMMIT_BRANCH == "dev")
#      when: always
#    - when: never

#   cache:
#     key: $CI_COMMIT_REF_SLUG


build_terraform_env:
  stage: build
  tags:
    - shell_runner_01
  before_script:
    - pwd && ls -altr && whoami
    # install terraform
    - sudo apt-get update && sudo apt-get install -y gnupg software-properties-common curl
    - curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
    - sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    - sudo apt-get update && sudo apt-get install terraform
    - sudo terraform --version
    # install docker
    # - sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
    # - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    # - sudo apt-key fingerprint 0EBFCD88
    # - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
    # - apt-cache policy docker-ce
    # - sudo apt-get install -y docker-ce
    # - sudo systemctl status docker
    # - sudo usermod -aG docker $USER
    # - sudo systemctl enable docker
    # - docker --version
    # install aws cli
    - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - sudo apt-get install -y unzip 
    - unzip awscliv2.zip
    - sudo ./aws/install --update
    - aws --version && ls -altr && realpath .
  script:
    - ls